From d3a905cc72208b773bb58a6852315fb1addda358 Mon Sep 17 00:00:00 2001
From: nicknitewolf <nickradiantwtf@gmail.com>
Date: Thu, 29 Dec 2016 22:36:54 +0800
Subject: [PATCH] kenzo: Initial Goodix FP

boardconfig: make selinux permissive for goodix
---
 BoardConfigCommon.mk     |  2 +-
 rootdir/etc/init.qcom.rc | 14 ++++++++++++++
 rootdir/etc/init.qcom.sh |  6 ++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/BoardConfigCommon.mk b/BoardConfigCommon.mk
index c88564d..d3952c8 100644
--- a/BoardConfigCommon.mk
+++ b/BoardConfigCommon.mk
@@ -45,7 +45,7 @@ TARGET_BOOTLOADER_BOARD_NAME := msm8952
 TARGET_NO_BOOTLOADER := true
 
 # Kernel
-BOARD_KERNEL_CMDLINE := console=ttyHSL0,115200,n8 androidboot.console=ttyHSL0 androidboot.hardware=qcom ehci-hcd.park=3 androidboot.bootdevice=7824900.sdhci lpm_levels.sleep_disabled=1 ramoops_memreserve=4M
+BOARD_KERNEL_CMDLINE := console=ttyHSL0,115200,n8 androidboot.console=ttyHSL0 androidboot.hardware=qcom ehci-hcd.park=3 androidboot.bootdevice=7824900.sdhci lpm_levels.sleep_disabled=1 ramoops_memreserve=4M androidboot.selinux=permissive
 BOARD_KERNEL_BASE := 0x80000000
 BOARD_KERNEL_PAGESIZE := 2048
 BOARD_MKBOOTIMG_ARGS := --ramdisk_offset 0x01000000 --tags_offset 0x00000100
diff --git a/rootdir/etc/init.qcom.rc b/rootdir/etc/init.qcom.rc
index bf0bbb6..c882940 100644
--- a/rootdir/etc/init.qcom.rc
+++ b/rootdir/etc/init.qcom.rc
@@ -153,6 +153,10 @@ on boot
     chown system system /sys/class/leds/green/led_time
     chown system system /sys/class/leds/blue/led_time
 
+    # Goodix FP
+    chown system system /dev/goodix_fp
+    chmod 0644 /dev/goodix_fp
+
 # msm specific files that need to be created on /data
 on post-fs-data
     # Create directory for TZ Apps
@@ -291,6 +295,7 @@ on post-fs-data
     # Fingerprint
     mkdir /data/fpc 0770 system system
     mkdir /data/fpc/s 0770 system system
+    mkdir /data/goodix 0770 system system
 
     mkdir /data/tombstones 0771 system system
     mkdir /tombstones/modem 0771 system system
@@ -678,3 +683,12 @@ service imscmservice /system/bin/imscmservice
 on property:sys.ims.DATA_DAEMON_STATUS=1
     start ims_rtp_daemon
     start imscmservice
+
+service gx_fpd /system/bin/gx_fpd
+    class late_start
+    user system
+    group system
+    disabled
+
+on property:persist.sys.fp.sensor=goodix
+    start gx_fpd
diff --git a/rootdir/etc/init.qcom.sh b/rootdir/etc/init.qcom.sh
index 1ee6e49..36d1e36 100644
--- a/rootdir/etc/init.qcom.sh
+++ b/rootdir/etc/init.qcom.sh
@@ -120,3 +120,9 @@ if [ -f /system/etc/mbn_ota.txt ] && [ ! -f /data/misc/radio/modem_config/mbn_ot
     chown radio.radio /data/misc/radio/modem_config/mbn_ota.txt
 fi
 echo 1 > /data/misc/radio/copy_complete
+
+if [ -d /sys/class/goodix_fp ]; then
+    setprop persist.sys.fp.sensor goodix
+else
+    setprop persist.sys.fp.sensor fpc
+fi
